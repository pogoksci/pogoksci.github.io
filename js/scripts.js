// =================================================================
// 0. Ï†ÑÏó≠ Î≥ÄÏàò Î∞è ÏÑ§Ï†ï
// =================================================================

// üö® Supabase Î∞è Edge Function ÏÑ§Ï†ï (index.html <head>ÏóêÏÑú Ï†ïÏùòÎêòÏóàÍ±∞ÎÇò Ïó¨Í∏∞Ïóê Ìè¨Ìï®ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§)
const SUPABASE_URL = "https://muprmzkvrjacqatqxayf.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cHJtemt2cmphY3FhdHF4YXlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MDM4MjgsImV4cCI6MjA3NDM3OTgyOH0.a4gUjlp9reaO28kxdLrh5dF0IUscXWgtXbB7PY4wWsk";
const FUNCTION_NAME = "casimport"; 
const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/${FUNCTION_NAME}`;

// üîë Î≤ÑÌäº Í∑∏Î£πÏùò ÏÑ†ÌÉù Í∞íÏùÑ Ï†ÄÏû•Ìï† Ï†ÑÏó≠ Î≥ÄÏàò
let selectedClassification = null; // üîë ÏÉàÎ°úÏö¥ Ï†ÑÏó≠ Î≥ÄÏàò Ï∂îÍ∞Ä
let selectedState = null;
let selectedUnit = null; 
let selectedConcentrationUnit = null;
let selectedManufacturer = null; // ‚ö†Ô∏è manufactureÎèÑ Ï†ÑÏó≠ Î≥ÄÏàòÏó¨Ïïº Ìï©ÎãàÎã§.

// Ï†ÑÏó≠ÏóêÏÑú Ï†ëÍ∑ºÌï¥Ïïº ÌïòÎäî HTML ÏöîÏÜåÎì§ (Ï¥àÍ∏∞Í∞íÏùÄ null)
let statusMessage = null;
let photoInput = null;
let cameraInput = null;
let photoPreview = null;
let manufacturerButtonsGroup = null;
let otherManufacturerGroup = null;
let manufacturerOtherInput = null;


// =================================================================
// 1. HTML Ï°∞Í∞Å ÌååÏùº Î°úÎçî Ìï®Ïàò
// =================================================================

/**
 * ÏßÄÏ†ïÎêú URLÏóêÏÑú HTML ÎÇ¥Ïö©ÏùÑ Í∞ÄÏ†∏ÏôÄ ÌäπÏ†ï ÏöîÏÜåÏóê ÏÇΩÏûÖ ÌõÑ ÏΩúÎ∞± Ìï®ÏàòÎ•º Ïã§ÌñâÌï©ÎãàÎã§.
 */
function includeHTML(url, targetElementId, callback) {
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to load ${url}: ${response.status} ${response.statusText}`);
            }
            return response.text();
        })
        .then(htmlContent => {
            const targetElement = document.getElementById(targetElementId);
            if (targetElement) {
                // Î∂àÎü¨Ïò® HTML ÎÇ¥Ïö©ÏùÑ ÎåÄÏÉÅ ÏöîÏÜåÏóê ÏÇΩÏûÖ
                targetElement.innerHTML = htmlContent;

                // HTML ÏÇΩÏûÖ ÏôÑÎ£å ÌõÑ, ÏΩúÎ∞± Ìï®ÏàòÎ•º Ïã§ÌñâÌïòÏó¨ ÎèôÏ†Å ÏöîÏÜåÎ•º Ï¥àÍ∏∞Ìôî
                if (callback) {
                    callback();
                }
            } else {
                console.error(`Target element not found: #${targetElementId}`);
            }
        })
        .catch(error => {
            console.error('Error during HTML include:', error);
            // Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú (statusMessageÍ∞Ä Î°úÎìúÎêòÏñ¥ ÏûàÎã§Í≥† Í∞ÄÏ†ï)
            const msgElement = document.getElementById('statusMessage');
            if (msgElement) {
                msgElement.textContent = `ÌéòÏù¥ÏßÄ Î°úÎìú Ïò§Î•ò: ${url}`;
            }
        });
}


// =================================================================
// 2. Ìèº ÏöîÏÜå Ï¥àÍ∏∞Ìôî Î°úÏßÅ (ÏΩúÎ∞± Ìï®Ïàò)
// =================================================================

/**
 * form-input.html ÎÇ¥Î∂ÄÏùò ÎèôÏ†ÅÏúºÎ°ú ÏÇΩÏûÖÎêú ÏöîÏÜåÎì§Ïóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎ•º Ïó∞Í≤∞ÌïòÍ≥† Ï†ÑÏó≠ Î≥ÄÏàòÎ•º Ïû¨ÏÑ§Ï†ïÌï©ÎãàÎã§.
 */
function initializeFormListeners() {
    console.log("Ìèº ÏöîÏÜå Ï¥àÍ∏∞Ìôî ÏãúÏûë...");

    // üìå Ï†ÑÏó≠ Î≥ÄÏàò Ïû¨Ìï†Îãπ: ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎêú ÏöîÏÜåÎ•º Ï∞æÏäµÎãàÎã§.
    let selectedManufacturer = null;
    statusMessage = document.getElementById('statusMessage');
    photoInput = document.getElementById('file_select');
    cameraInput = document.getElementById('camera_capture');
    photoPreview = document.getElementById('photo_preview');
    manufacturerButtonsGroup = document.getElementById('manufacturer_buttons');
    otherManufacturerGroup = document.getElementById('other_manufacturer_group');
    manufacturerOtherInput = document.getElementById('manufacturer_other');
    
    // --- Î≤ÑÌäº Í∑∏Î£π ÏÑ§Ï†ï Ïã§Ìñâ ---
    setupButtonGroup('state_buttons');
    setupButtonGroup('unit_buttons', 'g');
    setupButtonGroup('concentration_unit_buttons'); 
    setupButtonGroup('manufacturer_buttons'); 

    // --- ÏÇ¨ÏßÑ ÌååÏùº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ---
    if (photoInput) photoInput.addEventListener('change', handlePhotoChange);
    if (cameraInput) cameraInput.addEventListener('change', handlePhotoChange);
    
    // --- 'Í∏∞ÌÉÄ' Ï†úÏ°∞ÏÇ¨ ÏûÖÎ†•ÎûÄ ÌëúÏãú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ---
    if (manufacturerButtonsGroup) {
        manufacturerButtonsGroup.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                const value = event.target.getAttribute('data-value');
                if (value === 'Í∏∞ÌÉÄ') {
                    otherManufacturerGroup.style.display = 'block'; 
                    manufacturerOtherInput.setAttribute('required', 'required'); 
                } else {
                    otherManufacturerGroup.style.display = 'none'; 
                    manufacturerOtherInput.removeAttribute('required');
                    manufacturerOtherInput.value = '';
                }
            }
        });
    }

    console.log("Ìèº ÏöîÏÜå Ï¥àÍ∏∞Ìôî ÏôÑÎ£å.");
}


// =================================================================
// 3. Î≤ÑÌäº Í∑∏Î£π Ìï∏Îì§Îü¨ Ìï®Ïàò
// =================================================================

function setupButtonGroup(groupId, initialValue = null) {
    const group = document.getElementById(groupId);
    if (!group) return; 

    group.addEventListener('click', (event) => {
        const targetButton = event.target.closest('button');
        if (targetButton) {
            // Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
            group.querySelectorAll('.active').forEach(btn => {
                btn.classList.remove('active');
            });
            targetButton.classList.add('active');

            // Ï†ÑÏó≠ Î≥ÄÏàò Í∞í ÏóÖÎç∞Ïù¥Ìä∏
            const value = targetButton.getAttribute('data-value');
            if (groupId === 'state_buttons') {
                selectedState = value;
            } else if (groupId === 'unit_buttons') {
                selectedUnit = value;
            } else if (groupId === 'concentration_unit_buttons') {
                selectedConcentrationUnit = value;
            } else if (groupId === 'manufacturer_buttons') {
                selectedManufacturer = value;
            }
        }
    });

    // Ï¥àÍ∏∞Í∞í ÏÑ§Ï†ï
    if (initialValue) {
        const initialButton = group.querySelector(`button[data-value="${initialValue}"]`);
        if (initialButton) {
            initialButton.classList.add('active');
        }
    }
}


// =================================================================
// 4. ÏÇ¨ÏßÑ ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ Ìï∏Îì§Îü¨
// =================================================================

function handlePhotoChange(event) {
    // photoPreviewÍ∞Ä Ïû¨Ìï†ÎãπÎêòÏóàÎäîÏßÄ ÌôïÏù∏
    if (!photoPreview) return; 
    
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            photoPreview.src = e.target.result;
            photoPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        photoPreview.style.display = 'none';
    }
}


// =================================================================
// 5. Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨ Ìï®Ïàò
// =================================================================

async function importData() {
    if (!statusMessage) return; 
    
    statusMessage.textContent = 'Îç∞Ïù¥ÌÑ∞Î•º Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§... Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.';
    statusMessage.style.color = 'blue';

    // 1. Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î∞è Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    const casRn = document.getElementById('cas_rn').value.trim();
    const purchaseVolumeStr = document.getElementById('purchase_volume').value;
    const concentrationValueStr = document.getElementById('concentration_value').value;
    const concentrationUnit = selectedConcentrationUnit; 
    const manufacturerSelect = selectedManufacturer; 
    const manufacturerOther = manufacturerOtherInput ? manufacturerOtherInput.value.trim() : ''; 
    const purchaseDate = document.getElementById('purchase_date').value;
    const classification = document.getElementById('classification').value;
    
    const state = selectedState; 
    const unit = selectedUnit; 

    if (!casRn) {
        statusMessage.textContent = 'CAS Î≤àÌò∏Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.';
        statusMessage.style.color = 'red';
        return;
    }

    // 2. Ïà´Ïûê Î≥ÄÌôò Î∞è NaN Ï≤òÎ¶¨
    const purchaseVolume = parseFloat(purchaseVolumeStr);
    const concentrationValue = parseFloat(concentrationValueStr);

    // Ï†úÏ°∞Ïõê ÏµúÏ¢Ö Í≤∞Ï†ï
    let finalManufacturer = null;
    if (manufacturerSelect === 'Í∏∞ÌÉÄ') {
        finalManufacturer = manufacturerOther || 'Í∏∞ÌÉÄ (ÎØ∏ÏûÖÎ†•)';
    } else {
        finalManufacturer = manufacturerSelect;
    }

    // 3. ÏÇ¨ÏßÑ ÌååÏùº Ï≤òÎ¶¨ (Base64 Ïù∏ÏΩîÎî©)
    let photoBase64 = null;
    const file = photoInput.files[0] || cameraInput.files[0];
    
    if (file) {
        photoBase64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64String = reader.result;
                if (typeof base64String === 'string') {
                    resolve(base64String.split(',')[1]); 
                } else {
                    resolve(null);
                }
            };
            reader.readAsDataURL(file);
        });
    }

    // 4. ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°Ìï† ÏµúÏ¢Ö Inventory Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
    const inventoryData = {
        casRns: [casRn], 
        inventoryDetails: {
            concentration_value: isNaN(concentrationValue) ? null : concentrationValue,
            concentration_unit: concentrationUnit || null,
            purchase_volume: isNaN(purchaseVolume) ? 0 : purchaseVolume,
            current_amount: isNaN(purchaseVolume) ? 0 : purchaseVolume,
            unit: unit,                      
            state: state,                    
            manufacturer: finalManufacturer,
            purchase_date: purchaseDate || null,
            classification: classification || null,
            photo_base64: photoBase64,
            location: 'Initial Check-in',
        }
    };
    
    try {
        // 5. Supabase Edge Function Ìò∏Ï∂ú (Anon KeyÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ïù∏Ï¶ù)
        const response = await fetch(EDGE_FUNCTION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 
            },
            body: JSON.stringify(inventoryData)
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || `HTTP Error! Status: ${response.status}`);
        }
        
        // 6. ÏÑ±Í≥µ ÏùëÎãµ Ï≤òÎ¶¨
        const result = data[0];
        let msg = '';
        
        if (result.isNewSubstance) {
            msg = `‚úÖ Ïã†Í∑ú Î¨ºÏßà(${casRn}) Ï†ïÎ≥¥ Î∞è ÏãúÏïΩÎ≥ë(${result.inventoryId}) Îì±Î°ù ÏôÑÎ£å!`;
        } else {
            msg = `‚úÖ Í∏∞Ï°¥ Î¨ºÏßà(${casRn})Ïóê ÏÉà ÏãúÏïΩÎ≥ë(${result.inventoryId}) Îì±Î°ù ÏôÑÎ£å!`;
        }

        statusMessage.textContent = msg;
        statusMessage.style.color = 'green';

    } catch (error) {
        console.error("Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
        statusMessage.textContent = `‚ùå Ïò§Î•ò: Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ïã§Ìå®. ÏΩòÏÜîÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî. (${error.message})`;
        statusMessage.style.color = 'red';
    }
}


// =================================================================
// 6. ÌéòÏù¥ÏßÄ ÏßÑÏûÖÏ†ê (ÏµúÏ¢Ö Ïã§Ìñâ ÏãúÏûë)
// =================================================================

window.addEventListener('DOMContentLoaded', () => {
    // 1. form-input.html Î°úÎìú: ÏôÑÎ£å ÌõÑ „Éï„Ç©„Éº„É†ÂàùÊúüÂåñ Ìï®Ïàò(initializeFormListeners)Î•º ÏΩúÎ∞±ÏúºÎ°ú Ïã§Ìñâ
    // ‚ö†Ô∏è index.htmlÏóê <div id="form-container"></div> Í∞Ä ÏûàÏñ¥Ïïº Ìï©ÎãàÎã§.
    includeHTML('pages/form-input.html', 'form-container', initializeFormListeners); 
    
    // 2. navbar.html Î°úÎìú
    includeHTML('pages/navbar.html', 'navbar-container'); 
    
    // ‚ùå Í≤ΩÍ≥†: Ïó¨Í∏∞Ïóê ÏûàÎäî initializeFormListeners() Ìò∏Ï∂úÏùÄ ÏÇ≠Ï†úÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.
    // initializeFormListeners(); 
});